@model HistoryIndexVm
@{
    ViewData["Title"] = "History";
}

<div class="history-page">
    <div class="hp-index-header">
        <h1 class="hp-heading">Progress History</h1>

        <form method="get" asp-controller="Progress" asp-action="History" class="hp-filter">
            <div class="hp-filter-row">
                <input type="text" name="q" value="@Model.Query"
                       class="cp-input hp-filter-input" placeholder="Search order no or barcode..." />
                <button type="submit" class="hp-filter-btn">Go</button>
                @if (!string.IsNullOrWhiteSpace(Model.Query))
                {
                    <a asp-controller="Progress" asp-action="History" class="hp-clear-btn">Clear</a>
                }
            </div>
        </form>
    </div>

    @if (Model.Items.Count == 0)
    {
        <div class="hp-empty">
            @if (!string.IsNullOrWhiteSpace(Model.Query))
            {
                <div class="hp-empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </div>
                <div class="hp-empty-title">No results</div>
                <div class="hp-empty-sub">Nothing matches <strong>@Model.Query</strong></div>
            }
            else
            {
                <div class="hp-empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                </div>
                <div class="hp-empty-title">No ERP items found</div>
                <div class="hp-empty-sub">Sync barcode data from ERP to get started</div>
            }
        </div>
    }
    else
    {
        <div class="hp-summary">
            <strong>@Model.Items.Count</strong> item@(Model.Items.Count != 1 ? "s" : "")@(!string.IsNullOrWhiteSpace(Model.Query) ? $" matching \"{Model.Query}\"" : "")
        </div>

        <div class="hp-barcode-list">
            @foreach (var item in Model.Items)
            {
                var typeLower = item.OrderType?.Trim().ToLowerInvariant();
                var badgeClass = typeLower == "sample" ? "cp-erp-badge-sample" : "cp-erp-badge-order";

                <a href="/WorkProgress/@Uri.EscapeDataString(item.Barcode)" class="hp-bc-card">
                    <div class="hp-bc-top">
                        <div class="hp-bc-primary">
                            <span class="hp-bc-order">@item.OrderNo</span>
                            @if (!string.IsNullOrWhiteSpace(item.DesignName))
                            {
                                <span class="hp-bc-design">@item.DesignName</span>
                            }
                        </div>
                        @if (!string.IsNullOrWhiteSpace(item.OrderType))
                        {
                            <span class="cp-erp-badge @badgeClass">@item.OrderType.Trim()</span>
                        }
                    </div>
                    <div class="hp-bc-barcode">@item.Barcode</div>
                    <div class="hp-bc-meta">
                        @if (item.LogCount > 0)
                        {
                            <span>@item.LogCount log@(item.LogCount != 1 ? "s" : "")</span>
                            <span class="hp-pill hp-pill-total">@item.LatestTotalPercent!.Value.ToString("F1")%</span>
                            <span>@item.LatestCreatedAt!.Value.ToString("dd MMM HH:mm")</span>
                        }
                        else
                        {
                            <span class="hp-bc-no-logs">No logs yet</span>
                        }
                    </div>
                </a>
            }
        </div>
    }
</div>
