@model HistoryVm
@{
    ViewData["Title"] = "History";
}

<div class="cp-tl">
    <h1 class="cp-title">Progress History</h1>

    <form method="get" asp-controller="Progress" asp-action="History" class="cp-tl-filter">
        <input type="text" name="barcode" value="@Model.BarcodeFilter" class="cp-input" placeholder="Filter by barcode" />
        <button type="submit" class="cp-tl-filter-btn">Filter</button>
        @if (!string.IsNullOrWhiteSpace(Model.BarcodeFilter))
        {
            <a asp-controller="Progress" asp-action="History" class="cp-tl-clear">Clear</a>
        }
    </form>

    @if (Model.Logs.Count == 0)
    {
        <div class="cp-tl-empty">No records found.</div>
    }
    else
    {
        string? currentDate = null;
        @foreach (var log in Model.Logs)
        {
            var dateStr = log.ProgressDate.ToString("yyyy-MM-dd");
            if (dateStr != currentDate)
            {
                currentDate = dateStr;
                <div class="cp-tl-date">@log.ProgressDate.ToString("dd MMM yyyy")</div>
            }
            <div class="cp-tl-entry">
                <div class="cp-tl-rail">
                    <div class="cp-tl-dot"></div>
                    <div class="cp-tl-line"></div>
                </div>
                <div class="cp-tl-body">
                    <div class="cp-tl-time">@log.CreatedAt.ToString("HH:mm")</div>
                    @if (string.IsNullOrWhiteSpace(Model.BarcodeFilter))
                    {
                        <div class="cp-tl-barcode">@log.Barcode</div>
                    }
                    <div class="cp-tl-stats">
                        <div class="cp-tl-stat">
                            <span class="cp-tl-stat-label">Normal</span>
                            <span class="cp-tl-stat-value">@log.NormalPercent.ToString("F2")%</span>
                        </div>
                        <div class="cp-tl-stat">
                            <span class="cp-tl-stat-label">OT</span>
                            <span class="cp-tl-stat-value">@log.OtPercent.ToString("F2")%</span>
                        </div>
                        <div class="cp-tl-stat cp-tl-stat-total">
                            <span class="cp-tl-stat-label">Total</span>
                            <span class="cp-tl-stat-value">@log.TotalPercent.ToString("F2")%</span>
                        </div>
                    </div>
                    <a href="@log.ImagePath" target="_blank" class="cp-tl-photo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        View photo
                    </a>
                </div>
            </div>
        }
    }

    <div class="cp-tl-bottom">
        <a asp-controller="Home" asp-action="Index" class="cp-scan-btn" style="display:inline-flex;width:auto;padding:0.7rem 1.5rem;font-size:0.92rem;border-radius:10px;text-decoration:none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Scan
        </a>
    </div>
</div>
